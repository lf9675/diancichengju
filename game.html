<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶£å‘³æ±‰è¯­ - æŒ‘æˆ˜æ¨¡å¼</title>
    <style>
        :root {
            --primary-pink: #ffcdd2;
            --dark-pink: #ef9a9a;
            --text-color: #4e342e;
            --bg-blue: #e3f2fd;
            --btn-shadow: 0 4px 0 #e57373;
            --hud-bg: rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: "Rounded Mplus 1c", "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: var(--bg-blue);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            padding-top: 60px; /* ä¸ºé¡¶éƒ¨ä»ªè¡¨ç›˜ç•™å‡ºç©ºé—´ */
        }

        /* --- æ–°å¢ï¼šé¡¶éƒ¨ä»ªè¡¨ç›˜ (HUD) --- */
        .hud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: var(--hud-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
            font-weight: bold;
            color: var(--text-color);
            font-size: 18px;
        }

        .timer-box span {
            color: #d32f2f; /* çº¢è‰²å¼ºè°ƒæ—¶é—´ */
        }

        .score-box span {
            color: #388e3c; /* ç»¿è‰²å¼ºè°ƒåˆ†æ•° */
        }

        /* --- åŸæœ‰æ ·å¼è°ƒæ•´ --- */
        header { margin-top: 10px; }
        h1 {
            background-color: var(--primary-pink);
            color: var(--text-color);
            padding: 5px 20px;
            border-radius: 20px;
            border: 2px dashed #fff;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .progress-container {
            width: 80%;
            height: 8px;
            background-color: #fff;
            border-radius: 10px;
            margin: 5px 0 15px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #81c784;
            width: 0%;
            transition: width 0.3s ease;
        }

        .game-area {
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1; /* è®©æ¸¸æˆåŒºåŸŸå¡«å……å‰©ä½™ç©ºé—´ */
        }

        .target-box {
            background-color: rgba(255, 255, 255, 0.6);
            border: 3px dashed var(--dark-pink);
            border-radius: 20px;
            min-height: 120px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            padding: 10px;
            gap: 8px;
            position: relative;
            transition: all 0.3s;
        }

        .placeholder-text {
            position: absolute;
            color: #b0bec5;
            font-size: 16px;
            pointer-events: none;
        }

        .source-box {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            min-height: 80px;
            padding: 5px;
            align-content: flex-start; /* é˜²æ­¢è¯è¯­è¿‡åº¦åˆ†æ•£ */
        }

        .word-btn {
            background-color: var(--primary-pink);
            color: var(--text-color);
            font-size: 22px;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 12px;
            border: 2px dashed #fff;
            cursor: pointer;
            box-shadow: var(--btn-shadow);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .word-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 transparent;
        }

        .check-btn {
            background-color: #81c784;
            color: white;
            font-size: 20px;
            padding: 12px;
            border: none;
            border-radius: 50px;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 0 #4caf50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .check-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* åŠ¨ç”»ä¸åé¦ˆ */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.4s ease-in-out; border-color: #ff5252; }

        .feedback {
            height: 30px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            opacity: 0; /* é»˜è®¤éšè— */
            transition: opacity 0.3s ease;
        }
        .feedback.show { opacity: 1; }
        .success-text { color: #4caf50; }
        .error-text { color: #ff5252; }

        /* --- æ–°å¢ï¼šå¼€å§‹ç•Œé¢é®ç½© --- */
        #startOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-blue);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .start-btn {
            padding: 15px 40px;
            font-size: 24px;
            background-color: var(--primary-pink);
            border: 3px dashed #fff;
            border-radius: 50px;
            color: var(--text-color);
            cursor: pointer;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

<div id="startOverlay">
    <h1>å‡†å¤‡å¥½äº†å—ï¼Ÿ</h1>
    <p>é™æ—¶æŒ‘æˆ˜ï¼Œç´§å¼ åˆºæ¿€ï¼</p>
    <button class="start-btn" onclick="startGame()">ç‚¹å‡»å¼€å§‹æ¸¸æˆ</button>
</div>

<div class="hud-container">
    <div class="timer-box">â±ï¸ æ—¶é—´: <span id="timerDisplay">30</span></div>
    <div class="score-box">â­ åˆ†æ•°: <span id="scoreDisplay">0</span></div>
</div>

<header>
    <h1>ç‚¹è¯æˆå¥ - æŒ‘æˆ˜ç‰ˆ</h1>
</header>

<div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
</div>

<div class="game-area">
    <div class="target-box" id="targetBox">
        <span class="placeholder-text">ç‚¹å‡»è¯è¯­ç»„æˆå¥å­</span>
    </div>

    <div class="source-box" id="sourceBox">
        </div>

    <div class="feedback" id="feedback"></div>

    <button class="check-btn" id="checkBtn" onclick="checkAnswer()">æ£€æŸ¥å¥å­</button>
</div>

<script>
    // ----------------é…ç½®åŒºåŸŸ----------------
    const TIME_LIMIT_PER_LEVEL = 30; // æ¯å…³æ—¶é—´é™åˆ¶ï¼ˆç§’ï¼‰
    const POINTS_PER_CORRECT = 10;   // æ¯é¢˜å¾—åˆ†

    const levels = [
        { words: ["å¦ˆå¦ˆ", "åœ¨", "å¨æˆ¿", "åšé¥­"], correct: "å¦ˆå¦ˆåœ¨å¨æˆ¿åšé¥­" },
        { words: ["ä»Šå¤©", "å¤©æ°”", "éå¸¸", "å¥½"], correct: "ä»Šå¤©å¤©æ°”éå¸¸å¥½" },
        { words: ["æˆ‘", "æƒ³", "å»", "ä¸­å›½", "æ—…æ¸¸"], correct: "æˆ‘æƒ³å»ä¸­å›½æ—…æ¸¸" },
        { words: ["è¿™", "æ˜¯", "ä»€ä¹ˆ", "æ°´æœ"], correct: "è¿™æ˜¯ä»€ä¹ˆæ°´æœ" },
        { words: ["è™½ç„¶", "ä¸‹é›¨", "ä½†æ˜¯", "æˆ‘", "è¿˜è¦", "å»"], correct: "è™½ç„¶ä¸‹é›¨ä½†æ˜¯æˆ‘è¿˜è¦å»" }
    ];

    // ----------------å…¨å±€å˜é‡----------------
    let currentLevel = 0;
    let score = 0;
    let timeLeft = TIME_LIMIT_PER_LEVEL;
    let timerInterval;
    let tickerInterval; // ç”¨äºèƒŒæ™¯æ»´ç­”å£°
    let feedbackTimeout; // ç”¨äºæ§åˆ¶åé¦ˆæ–‡å­—æ¶ˆå¤±
    let isGameActive = false;
    
    // DOM å…ƒç´ 
    const targetBox = document.getElementById('targetBox');
    const sourceBox = document.getElementById('sourceBox');
    const feedback = document.getElementById('feedback');
    const checkBtn = document.getElementById('checkBtn');
    const progressBar = document.getElementById('progressBar');
    const timerDisplay = document.getElementById('timerDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const startOverlay = document.getElementById('startOverlay');

    // éŸ³é¢‘ä¸Šä¸‹æ–‡
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- æ¸¸æˆæµç¨‹æ§åˆ¶ ---

    // ç‚¹å‡»å¼€å§‹æŒ‰é’®è§¦å‘
    function startGame() {
        startOverlay.style.display = 'none';
        // æ¿€æ´»éŸ³é¢‘ç¯å¢ƒï¼ˆæµè§ˆå™¨è¦æ±‚å¿…é¡»æœ‰ç”¨æˆ·äº¤äº’ï¼‰
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        loadLevelDOM();
    }

    // åŠ è½½å…³å¡
    function loadLevelDOM() {
         if (currentLevel >= levels.length) {
            gameComplete();
            return;
        }
        isGameActive = true;

        // é‡ç½®ç•Œé¢çŠ¶æ€
        targetBox.innerHTML = '<span class="placeholder-text">å¿«é€Ÿç»„å¥ï¼</span>';
        sourceBox.innerHTML = '';
        feedback.textContent = '';
        feedback.className = 'feedback';
        checkBtn.textContent = "æ£€æŸ¥å¥å­";
        checkBtn.onclick = checkAnswer;
        checkBtn.disabled = false;
        targetBox.classList.remove('shake');
        clearTimeout(feedbackTimeout); // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„åé¦ˆå®šæ—¶å™¨

        // æ›´æ–°è¿›åº¦å’Œåˆ†æ•°UI
        progressBar.style.width = `${(currentLevel / levels.length) * 100}%`;
        scoreDisplay.innerText = score;

        // ç”Ÿæˆè¯å¡
        let words = [...levels[currentLevel].words];
        words.sort(() => Math.random() - 0.5);
        words.forEach((word) => {
            let btn = createWordBtn(word);
            btn.onclick = function() { moveWord(this); };
            sourceBox.appendChild(btn);
        });

        // å¯åŠ¨å®šæ—¶å™¨å’ŒèƒŒæ™¯éŸ³
        startTimer();
        startTickingBGM();
    }

    // åˆ›å»ºè¯å¡æŒ‰é’®
    function createWordBtn(text) {
        let btn = document.createElement('div');
        btn.className = 'word-btn';
        btn.innerText = text;
        return btn;
    }

    // ç§»åŠ¨è¯å¡
    function moveWord(element) {
        if (!isGameActive) return;
        // æ’­æ”¾çŸ­ä¿ƒçš„ç‚¹å‡»éŸ³
        playTone(400, "sine", 0.05);

        if (element.parentElement === sourceBox) {
            const placeholder = targetBox.querySelector('.placeholder-text');
            if (placeholder) placeholder.style.display = 'none';
            targetBox.appendChild(element);
        } else {
            sourceBox.appendChild(element);
            if (targetBox.querySelectorAll('.word-btn').length === 0) {
                const placeholder = targetBox.querySelector('.placeholder-text');
                if (placeholder) placeholder.style.display = 'block';
            }
        }
    }

    // --- æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥ã€è®¡æ—¶ã€è®¡åˆ† ---

    // å¼€å§‹è®¡æ—¶å™¨
    function startTimer() {
        clearInterval(timerInterval);
        timeLeft = TIME_LIMIT_PER_LEVEL;
        timerDisplay.innerText = timeLeft;
        
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                checkAnswer(true); // è¶…æ—¶å¼ºåˆ¶æ£€æŸ¥
            }
        }, 1000);
    }

    // åœæ­¢è®¡æ—¶å’ŒèƒŒæ™¯éŸ³
    function stopTimers() {
        clearInterval(timerInterval);
        clearInterval(tickerInterval);
    }

    // æ£€æŸ¥ç­”æ¡ˆ (forceFail: æ˜¯å¦å› è¶…æ—¶å¼ºåˆ¶åˆ¤å®šå¤±è´¥)
    function checkAnswer(forceFail = false) {
        if (!isGameActive) return;
        isGameActive = false; // é”å®šæ¸¸æˆçŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        stopTimers();
        checkBtn.disabled = true; // ç¦ç”¨æ£€æŸ¥æŒ‰é’®

        const currentWords = Array.from(targetBox.querySelectorAll('.word-btn')).map(btn => btn.innerText);
        const userSentence = currentWords.join('');
        const correctSentence = levels[currentLevel].correct;

        if (!forceFail && userSentence === correctSentence) {
            handleSuccess();
        } else {
            handleError(forceFail);
        }
    }

    // å¤„ç†æˆåŠŸ
    function handleSuccess() {
        score += POINTS_PER_CORRECT;
        scoreDisplay.innerText = score;
        scoreDisplay.style.transform = 'scale(1.2)'; // åˆ†æ•°æ”¾å¤§æç¤ºåŠ¨ç”»
        setTimeout(() => scoreDisplay.style.transform = 'scale(1)', 300);

        showFeedback("å¤ªæ£’äº†ï¼+10åˆ†", "success-text");
        playTone(600, "triangle", 0.1);
        playTone(800, "triangle", 0.1, 100);
        confettiEffect();

        // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€å…³
        setTimeout(() => {
            currentLevel++;
            loadLevelDOM();
        }, 3000); // 3ç§’åè‡ªåŠ¨ä¸‹ä¸€é¢˜
    }

    // å¤„ç†å¤±è´¥
    function handleError(isTimeout) {
        targetBox.classList.add('shake');
        playTone(200, "sawtooth", 0.4); // å¤±è´¥é•¿éŸ³

        let msg = isTimeout ? "æ—¶é—´åˆ°ï¼" : "ä¸å¯¹å“¦ï¼Œå†è¯•è¯•ã€‚";
        showFeedback(msg, "error-text");

        // å»¶è¿Ÿåå…è®¸é‡è¯•
        setTimeout(() => {
            targetBox.classList.remove('shake');
            isGameActive = true; // è§£é”çŠ¶æ€
            checkBtn.disabled = false;
            checkBtn.textContent = "å†è¯•ä¸€æ¬¡";
            // é‡ç½®è¯è¯­ä½ç½® (å¯é€‰ï¼Œè¿™é‡Œé€‰æ‹©è®©ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´)
             startTimer(); // é‡æ–°å¼€å§‹è®¡æ—¶
             startTickingBGM(); // é‡æ–°å¼€å§‹èƒŒæ™¯éŸ³
        }, 3000); // 3ç§’åå…è®¸é‡è¯•
    }

    // æ˜¾ç¤ºåé¦ˆä¿¡æ¯ (æ§åˆ¶æ˜¾ç¤ºæ—¶é•¿)
    function showFeedback(text, className) {
        feedback.textContent = text;
        feedback.className = `feedback show ${className}`;
        // ç¡®ä¿3ç§’åæ¸…é™¤æ–‡å­—ï¼ˆå¦‚æœåœ¨ handleSuccess/Error ä¸­æ²¡æœ‰è¢«è¦†ç›–çš„è¯ï¼‰
        clearTimeout(feedbackTimeout);
        feedbackTimeout = setTimeout(() => {
            feedback.className = 'feedback'; // ç§»é™¤ show ç±»ï¼Œä½¿å…¶é€æ˜
        }, 2800);
    }

    // æ¸¸æˆç»“æŸ
    function gameComplete() {
        stopTimers();
        targetBox.innerHTML = "ğŸ‰";
        sourceBox.innerHTML = `<h2>æŒ‘æˆ˜å®Œæˆï¼<br>æœ€ç»ˆå¾—åˆ†: ${score}</h2>`;
        checkBtn.style.display = "none";
        progressBar.style.width = "100%";
        feedback.textContent = "";
        document.querySelector('.hud-container').style.display = 'none'; // éšè— HUD
        playTone(523.25, "sine", 0.2); // C5
        playTone(659.25, "sine", 0.2, 200); // E5
        playTone(783.99, "sine", 0.4, 400); // G5
    }

    // --- éŸ³æ•ˆä¸ç‰¹æ•ˆ ---

    // å¼€å§‹èƒŒæ™¯æ»´ç­”å£° (æ¨¡æ‹Ÿç´§å¼ æ„Ÿ)
    function startTickingBGM() {
        clearInterval(tickerInterval);
        // ä½¿ç”¨ä¸¤ä¸ªä¸åŒé¢‘ç‡çš„çŸ­éŸ³æ¨¡æ‹Ÿ "æ»´-ç­”"
        tickerInterval = setInterval(() => {
             // æ»´ (é«˜é¢‘çŸ­ä¿ƒ)
            playTone(1000, "sine", 0.03, 0, 0.02);
            // ç­” (ç¨ä½é¢‘çŸ­ä¿ƒï¼Œ500mså)
            setTimeout(() => {
                if(isGameActive) playTone(800, "sine", 0.03, 0, 0.02);
            }, 500);
        }, 1000);
    }

    // ç®€æ˜“éŸ³æ•ˆåˆæˆå™¨ (ä¼˜åŒ–ç‰ˆï¼Œæ§åˆ¶éŸ³é‡æ¸å˜)
    function playTone(freq, type, duration, delay = 0, vol = 0.1) {
        setTimeout(() => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = type;
            oscillator.frequency.value = freq;
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.start();
            // éŸ³é‡åŒ…ç»œï¼šå¿«é€Ÿå¼€å§‹ï¼Œç¼“æ…¢ç»“æŸ
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);

            oscillator.stop(audioCtx.currentTime + duration + 0.1);
        }, delay);
    }

    // æ’’èŠ±ç‰¹æ•ˆ (ç®€åŒ–ç‰ˆ)
    function confettiEffect() {
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#2196f3', '#4caf50', '#ffeb3b', '#ff5722'];
        for (let i = 0; i < 30; i++) {
            const confetti = document.createElement('div');
            confetti.style.position = 'fixed';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.top = '-20px';
            confetti.style.width = '8px';
            confetti.style.height = '8px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.zIndex = '200';
            // éšæœºä¸‹è½åŠ¨ç”»æ—¶é—´
            confetti.style.transition = `top ${1 + Math.random()}s ease-out, transform ${1 + Math.random()}s linear, opacity 1s`;
            document.body.appendChild(confetti);

            setTimeout(() => {
                confetti.style.top = '100vh';
                confetti.style.transform = `rotate(${Math.random() * 360}deg) scale(0.5)`;
                confetti.style.opacity = '0';
            }, 50);
            setTimeout(() => confetti.remove(), 2500);
        }
    }

</script>
</body>
</html>
